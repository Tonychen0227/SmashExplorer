@model ExploreModel

<script>
    var isShowing = false;
    function foo() {
        const elements = document.getElementsByClassName("emojiSpan");
        for (const e of elements) {
            e.style.display = isShowing ? 'none' : 'inline';
        }

        isShowing = !isShowing;
    }
</script>
<div class="jumbotron">
    <h1>Explore - @Model.VanityLink.Name</h1>
    <h3 style="display:inline-block"><a href="https://www.start.gg/@Model.Event.Slug" target="_blank">@Model.Event.Name
            </a> @@ @Model.Event.TournamentName</h3><a style="display:inline-block;margin-left:10px;margin-bottom:5px" class="btn btn-info" href="https://www.start.gg/@Model.Event.Slug" target="_blank">
    View on start.gg</a>
    <div class="row" style="margin-top:10px">
    @Html.ActionLink("Check Upsets", null, "Upsets", new { id = Model.Event.Id }, new { @class = "btn btn-default" })
    @Html.ActionLink("Seed Visualizer", null, "SeedVisualizer", new { id = Model.Event.Id }, new { @class = "btn btn-default" })
    @Html.ActionLink("Copy to new Explore", null, "SelectEntrants", new { id = Model.VanityLink.Id }, new { @class = "btn btn-default" })
    </div>
</div>
@{
    var currentCount = 0;
    var sortedKeys = Model.DictKeys.OrderBy(x => x.Standing).ThenBy(x => x.Seeding).ToList();
    <button class="btn btn-toolbar" type="button" onclick="foo()">Toggle Emoji</button>
    for (var i = 0; i < sortedKeys.Count(); i+=2)
    {
    <div class="row">
        @for (var k = i; k < Math.Min(sortedKeys.Count(), i + 2); k++)
        {
            var entrant = sortedKeys[k];
            <div class="col-md-6">
                <div class="panel" style="border:1px solid gray;margin:4px">
                    <div class="panel-body">
                        <p style="border-bottom: 1px solid black; padding-bottom: 5px">
                            <a href="https://www.start.gg/@Model.Event.Slug/entrant/@entrant.Id" target="_blank"><strong>@entrant.Name</strong></a>
                            @{
                                List<int?> characters = new List<int?>();
                                foreach (var set in Model.EntrantsSets[entrant])
                                {
                                    if (set.Games != null)
                                    {
                                        var selections = set.Games.Where(x => x.Selections != null).SelectMany(x => x.Selections.Where(s => s.Entrant.Id == entrant.Id && s.SelectionType == "CHARACTER").Select(s => s.SelectionValue)).Distinct();
                                        characters.AddRange(selections);
                                    }
                                }

                                foreach (var character in characters.Distinct())
                                {
                                    if (character != null)
                                    {
                                        <img src="~/Content/Characters/@(character).jpg" style = "height:20px;width:20px" />
                                    }
                                }
                            }
                            - <strong>@SmashExplorerDatabase.Instance.GetStringOrdinal(entrant.Standing ?? null)</strong>
                            out of @Model.Event.NumEntrants (@SmashExplorerDatabase.Instance.GetStringOrdinal(entrant.Seeding) Seed)
                        </p>
                        @{
                            var sets = Model.EntrantsSets[entrant].OrderByDescending(x => x.CompletedAt).ThenByDescending(x => x.CreatedAt);
                            var highestPhase = sets.Max(x => x.PhaseOrder);
                            if (sets.Any(x => x.Id.StartsWith("preview") && x.PhaseOrder == highestPhase) 
                                && !sets.Any(x => !x.Id.StartsWith("preview") && x.PhaseOrder == highestPhase))
                            {
                                var firstPreviewSet = sets.Where(x => x.PhaseOrder == highestPhase && x.Id.StartsWith("preview")).FirstOrDefault();
                                var targetOpponent = firstPreviewSet.Entrants.Where(x => x.Id != entrant.Id).SingleOrDefault();
                                string opponentName;
                                if (!string.IsNullOrEmpty(targetOpponent.Name)) {
                                    opponentName = $"{targetOpponent.Name} ({@SmashExplorerDatabase.Instance.GetStringOrdinal(targetOpponent.InitialSeedNum)} seed)";
                                } else {
                                    var prereqSet = Model.AllSets.Where(x => x.Id == targetOpponent.PrereqId).FirstOrDefault();
                                    if (prereqSet == null) {
                                        opponentName = "???";
                                    } else {
                                        opponentName = string.Join(" / ", prereqSet.Entrants.Select(x => $"{x.Name} ({@SmashExplorerDatabase.Instance.GetStringOrdinal(x.InitialSeedNum)} seed)"));
                                    }
                                }
                                if (firstPreviewSet.PhaseId != null && firstPreviewSet.Id.Split('_').Length >= 2) { 
                                    <h5><strong>Upcoming Set:</strong> 
                                <a href="https://www.start.gg/@Model.Event.Slug/brackets/@firstPreviewSet.PhaseId/@firstPreviewSet.Id.Split('_')[1]" target="_blank">vs @opponentName</a></h5>
                                } else { 
                                    <h5><strong>Upcoming Set:</strong> vs @opponentName</h5>
                                }
                            }
                            var upcomingSet = sets.Where(x => !x.Id.StartsWith("preview") && (string.IsNullOrEmpty(x.WinnerId) || x.WinnerId == "None")).FirstOrDefault();
                            if (upcomingSet != null)
                            {
                                var opponent = upcomingSet.Entrants.Where(x => x.Id != entrant.Id).Single();
                                string opponentName;
                                if (opponent.Name != null)
                                {
                                    opponentName = $"{opponent.Name} ({SmashExplorerDatabase.Instance.GetStringOrdinal(opponent.InitialSeedNum)} Seed)";
                                }
                                else
                                {
                                    opponentName = $"{opponent.PrereqType} {opponent.PrereqId}";
                                    var prereqSet = Model.AllSets.Where(x => x.Id == opponent.PrereqId).FirstOrDefault();
                                    if (prereqSet != null)
                                    {
                                        opponentName = string.Join(" / ", prereqSet.Entrants.Select(x => $"{x.Name} ({@SmashExplorerDatabase.Instance.GetStringOrdinal(x.InitialSeedNum)} seed)"));
                                    }
                                }
                                <h5><strong>Upcoming Set: </strong><a href="https://www.start.gg/@Model.Event.Slug/set/@upcomingSet.Id" target="_blank">vs @opponentName</a>
                                @if (upcomingSet.Stream != null && upcomingSet.Stream.StreamSource == "TWITCH") { 
                                    <a href="https://www.twitch.tv/@upcomingSet.Stream.StreamName" target="_blank"><img src="~/Content/twitch.png" alt="Twitch" style="height:20px;width:20px"/></a>
                                }
                                </h5>
                            }
                            var pastSets = sets.Where(x => x.WinnerId != null && x.WinnerId != "None" && !x.Id.StartsWith("preview"));
                            if (pastSets.Count() > 0)
                            {
                                <h5><strong>Past Sets</strong></h5>
                                string storedSet = null;
                                foreach (var set in pastSets)
                                {
                                    var playerSelections = set.Games?.Where(x => x.Selections != null).SelectMany(x => x.Selections.Where(s => s.Entrant.Id == entrant.Id && s.SelectionType == "CHARACTER").Select(s => s.SelectionValue)).Distinct();

                                    var selections = set.Games?.Where(x => x.Selections != null).SelectMany(x => x.Selections.Where(s => s.Entrant.Id != entrant.Id && s.SelectionType == "CHARACTER").Select(s => s.SelectionValue)).Distinct();

                                    if (storedSet != set.PhaseName) {
                                        <strong><i>@set.PhaseName</i></strong><br/>
                                        storedSet = set.PhaseName;
                                    }
                                    var opponent = set.Entrants.Where(x => x.Id != entrant.Id).SingleOrDefault();
                                    string detailedScore;
                                    if (opponent != null && set.DetailedScore != null) {
                                        if (set.WinnerId == entrant.Id) {
                                            detailedScore = $"{set.DetailedScore[set.WinnerId]} - {set.DetailedScore[opponent.Id]}";
                                        } else {
                                            detailedScore = $"{set.DetailedScore[entrant.Id]} - {set.DetailedScore[opponent.Id]}";
                                        }
                                    } else {
                                        detailedScore = "DQ";
                                    }
                                    string url = "";
                                    if (!string.IsNullOrEmpty(set.PhaseId) && !string.IsNullOrEmpty(set.PhaseGroupId)) {
                                        url = $"https://www.start.gg/{Model.Event.Slug}/brackets/{set.PhaseId}/{set.PhaseGroupId}";
                                    } else {
                                        url = $"https://www.start.gg/{Model.Event.Slug}/set/{set.Id}";
                                    }
                                    <span>
                                    @if (playerSelections != null) {
                                        foreach(var selection in playerSelections.Distinct()) { 
                                            if (selection != null) { 
                                                <img style="height:20px;width:20px;" src="~/Content/Characters/@(selection).jpg" />
                                            }
                                        }
                                    }
                                    <a href="@url" target="_blank">
                                        @if (set.WinnerId == entrant.Id)
                                        {
                                            @:W @detailedScore
                                        }
                                        else
                                        {
                                            @:L @detailedScore
                                        } vs @if (set.Entrants.Count == 1)
                                        {
                                            @:Bye
                                        }
                                        else
                                        {
                                            @opponent.Name @:(@SmashExplorerDatabase.Instance.GetStringOrdinal(opponent.InitialSeedNum) Seed)
                                        }
                                    </a>
                                    @if (selections != null) {
                                        foreach(var selection in selections.Distinct()) { 
                                            if (selection != null) { 
                                                <img style="height:20px;width:20px;" src="~/Content/Characters/@(selection).jpg" />
                                            }
                                        }
                                    }

                                    <span class="emojiSpan" style="display:none">@if (set.BracketType == "DOUBLE_ELIMINATION" && set.Round > 0) { 
                                        if (set.WinnerId != entrant.Id) { 
                                            @:&#128315;
                                        } else {
                                            @:&#128994;
                                        }
                                    } else if ((set.BracketType == "DOUBLE_ELIMINATION" && set.Round < 0) || set.BracketType == "SINGLE_ELIMINATION") { 
                                        if (set.WinnerId != entrant.Id) { 
                                            @:&#128128;
                                        } else {
                                            @:	&#128075;
                                        } @SmashExplorerDatabase.Instance.GetStringOrdinal(set.LPlacement)
                                    }</span></span><br/>
                                }
                            }
                        }
                    </div>
                    <div class="panel-footer">
                        @foreach (var info in entrant.AdditionalInfo)
                        {
                            if (info == null)
                            {
                                continue;
                            }

                            foreach (var url in info.Urls.OrderByDescending(x => x.Url))
                            {
                                if (url?.Url != null)
                                {
                                    Uri uri = new Uri(url.Url);
                                    <a href="@url.Url" target="_blank">
                                        @if (url.Url.Contains("twitter.com"))
                                        {
                                            <img src="~/Content/twitter.png" alt="Twitter" style="width:30px;height:30px;">
                                        }
                                        else if (url.Url.Contains("twitch.tv"))
                                        {
                                            <img src="~/Content/twitch.png" alt="Twitch" style="width:30px;height:30px;">
                                        }
                                    </a>
                                }
                            }
                        }
                    </div>
                </div>
            </div>
        }
    </div>
    }
}
