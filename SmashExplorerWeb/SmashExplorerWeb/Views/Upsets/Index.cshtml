@model UpsetsModel

<script>
    function copyToClipboard() {
        var stringArgs = []

        stringArgs.push("# Upset Thread - [@Model.Event.Name @@ @Model.Event.TournamentName](https://www.start.gg/@Model.Event.Slug)")
        stringArgs.push("Upset factor @(Model.MinimumUpsetFactor ?? 1) minimum. Maximum upsetee seed @(Model.MaximumUpseteeSeed?.ToString() ?? "None")");

        @{ 
            var link = $"https://smashexplorer.gg/Upsets/{Model.Event.Id}";

            if (Model.MinimumUpsetFactor != null && Model.MaximumUpseteeSeed != null)
            {
                link += $"?minUpsetFactor={Model.MinimumUpsetFactor}&maxUpseteeSeed={Model.MaximumUpseteeSeed}";
            } else if (Model.MinimumUpsetFactor != null)
            {
                link += $"?minUpsetFactor={Model.MinimumUpsetFactor}";
            } else if (Model.MaximumUpseteeSeed != null)
            {
                link += $"?maxUpseteeSeed={Model.MaximumUpseteeSeed}";
            }


            @:console.log("@link".replace(/&amp;/g, '&'));
            @:console.log("&");
        }

        stringArgs.push(`Automatically generated by [SmashExplorer](${"@(link)".replace(/&amp;/g, '&')}) at @DateTime.UtcNow.ToString("G") UTC`);
        stringArgs.push(`UF = [Upset Factor](https://www.pgstats.com/articles/introducing-spr-and-uf)`)
        @{
            var argsList = new Dictionary<string, Dictionary<string, List<Upset>>>()
            {
                { "## Winners - Upsets", Model.WinnersUpsets },
                { "## Losers - Upsets", Model.LosersUpsets },
                { "## Winners - Notable", Model.WinnersNotable },
                { "## Losers - Notable", Model.LosersNotable }
            };

            var keys = argsList.Keys.ToList();

            if (keys != null)
            {
                for (var i = 0; i < keys.Count; i++)
                {
                    var key = keys[i];
                    var upsets = argsList[key];
                    var setAdded = false;
                    @:stringArgs.push("@key");
                    if (upsets?.Keys == null)
                    {
                        continue;
                    }
                    foreach (var phase in upsets.Keys)
                    {
                        var setsList = upsets[phase];
                        if (setsList.Count > 0) {
                            setAdded = true;
                            var firstSet = setsList[0];
                            @:stringArgs.push("[**@phase**](https://www.start.gg/@Model.Event.Slug/brackets/@firstSet.Set.PhaseId/@firstSet.Set.PhaseGroupId)");

                            foreach (var upset in setsList.OrderByDescending(x => x.UpsetFactor).ThenBy(x => x.Set.LPlacement))
                            {
                                var newString = upset.NewDisplayScore;
                                if (i % 2 == 1)
                                {
                                    var placementString = $"(out @ {SmashExplorerDatabase.Instance.GetStringOrdinal(upset.Set.LPlacement ?? -1)} in {phase})";
                                    newString = $"{newString} **{placementString}**";
                                }
                                @:stringArgs.push("* **UF @upset.UpsetFactor** - @newString ([set link](https://www.start.gg/@Model.Event.Slug/set/@upset.Set.Id))");
                            }
                        }
                    }

                    if (!setAdded)
                    {
                        @:stringArgs.push("No sets here!");
                    }
                }

                if (Model.DQEntrants != null && Model.DQEntrants.Count > 0)
                {
                    @:stringArgs.push("## DQs");
                    foreach (var dqEntrant in Model.DQEntrants)
                    {
                        @:stringArgs.push("@($"* [{dqEntrant.Name}](https://www.start.gg/{Model.Event.Slug}/entrant/{dqEntrant.Id}) ({dqEntrant.Seeding} seed)")");
                    }
                }
            }
        }

        var copiedString = stringArgs.join('\n\n');

        var el = document.createElement('textarea');
        // Set value (string to be copied)
        el.value = copiedString;
        // Set non-editable to avoid focus and move outside of view
        el.setAttribute('readonly', '');
        el.style = { position: 'absolute', left: '-9999px' };
        document.body.appendChild(el);
        // Select text inside element
        el.select();
        // Copy text to clipboard
        document.execCommand('copy');
        // Remove temporary element
        document.body.removeChild(el);
    }

    function foo(key, phaseName, eventName, eventId, setId, displayScore, additionalDisplay, upsetFactor) {
        var element = document.getElementById(setId);

        var args = [];

        var prefix = "UPSET FACTOR ";
        if (key.includes("Notable")) {
            prefix = "NOTABLE FACTOR ";
        }

        var stage = "LOSERS";
        if (key.includes("Winners")) {
            stage = "WINNERS";
        }

        args.push(prefix + upsetFactor + " at " + eventName + " (" + phaseName + " " + stage + ")");
        args.push(displayScore);
        args.push(additionalDisplay);
        args.push("For more upsets, check https://smashexplorer.gg/Upsets/" + eventId);
        args.push("Presented by @@SmashExplorer");

        element.href = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(args.join("\n\n"));
        element.target = "_blank";
    }
</script>
<div class="jumbotron">
    <h1>Upsets</h1>
    <h3 style="display:inline-block">
        @Model.Event.Name @@ @Model.Event.TournamentName
    </h3>
    <a style="display:inline-block;margin-left:10px;margin-bottom:5px" class="btn btn-info" href="https://www.start.gg/@Model.Event.Slug" target="_blank">
        View on start.gg
    </a>
    @if (string.IsNullOrWhiteSpace(Model.Message))
    {
        using (Html.BeginForm(null, null, FormMethod.Post))
        {
            var rawList = new List<int>() { 1, 2, 3, 4, 6, 8, 12, 16, 24, 32, 48, 64, 96, 128, 192, 256, 384, 512, 768, 1024, 1536, 2048, 3072 };
            var finalList = new List<int>();
            for (var i = 0; i < rawList.Count; i++) {
                finalList.Add(rawList[i]);
                if (rawList[i] > Model.MaxAvailableUpseteeSeed) {
                    break;
                }
            }
            @Html.DropDownListFor(x => x.MinimumUpsetFactor, new SelectList(Enumerable.Range(1, Model.MaximumUpsetFactor)), "Minimum Upset Factor",
            new { @class = "form-control col-md-2", @style = "height: 60px;" })
            @Html.DropDownListFor(x => x.MaximumUpseteeSeed, new SelectList(finalList), "Maximum Upsetee Seed",
            new { @class = "form-control col-md-2", @style = "height: 60px;" })
            @Html.ListBoxFor(m => m.SelectedPhases, Model.AvailablePhases, new
            {
                DropDownStyle = "DropdownList",
            @style = "overflow-y: scroll; height: 60px; margin-left:10px",
                @class = "listbox col-md-3"
            })
            <button type="submit" style="margin-left:10px;margin-top:10px;display:inline-block" class="btn btn-primary">Submit</button>
        }
    }
</div>
@if (string.IsNullOrWhiteSpace(Model.Message))
{
    <button type="button" onclick="copyToClipboard()" style="margin-left:10px;margin-top:10px;display:inline-block" class="btn btn-default">Copy markdown to clipboard</button>
}
<div class="row">
    @if (string.IsNullOrWhiteSpace(Model.Message))
    {
        var array = new Dictionary<string, Dictionary<string, List<Upset>>>() { { "Winners - Upsets", Model.WinnersUpsets }, { "Losers - Upsets", Model.LosersUpsets },
                  { "Winners - Notable" , Model.WinnersNotable }, { "Losers - Notable", Model.LosersNotable } };

        var keysList = array.Keys.ToList();
        for (var start = 0; start < keysList.Count; start += 2)
        {
            if (start % 2 == 0)
            {
                @:<div class="row">
                }
                for (var i = start; i <= start + 1; i++)
                {
                    var upsets = array[keysList[i]];
                    <div class="col-md-6">
                        <h3>
                            @keysList[i]@if (start == 2)
                        {<sup>Last game, potential upset</sup>}
                        </h3>
                        <div style="overflow-y: scroll; height: @Math.Min(75 + upsets.Values.Sum(x => x.Count)*75, 500)px ">
                            @foreach (var phase in upsets.Keys)
                            {
                                <h4>@phase</h4>
                                <table class="table table-hover">
                                    <tr>
                                        <th>Score</th>
                                        <th>Upset Factor</th>
                                    </tr>
                                    @foreach (var upset in upsets[phase].OrderByDescending(x => x.UpsetFactor).ThenBy(x => x.Set.LPlacement))
                                    {
                                        <tr>
                                            <td>
                                                <a href="https://www.start.gg/@Model.Event.Slug/set/@upset.Set.Id" target="_blank" class="col-md-9">
                                                    @{
                                                        if (upset.Set.Games != null)
                                                        {
                                                            var winnerSelections = upset.Set.Games?.Where(x => x.Selections != null)
                                                                .SelectMany(x => x.Selections.Where(k => k.Entrant.Id == upset.Set.WinnerId)
                                                                    .Where(k => k.SelectionType == "CHARACTER").Select(k => k.SelectionValue)).Distinct();

                                                            foreach (var selection in winnerSelections)
                                                            {
                                                                if (selection != null)
                                                                {
                                                                    <img style="width:20px;height:20px" src="~/Content/Characters/@(selection).jpg" />
                                                                }
                                                            }
                                                        }
                                                    }
                                                    @upset.NewDisplayScore
                                                    @{
                                                        if (upset.Set.Games != null)
                                                        {
                                                            var loserSelections = upset.Set.Games?.Where(x => x.Selections != null)
                                                                .SelectMany(x => x.Selections.Where(k => k.Entrant.Id != upset.Set.WinnerId)
                                                                    .Where(k => k.SelectionType == "CHARACTER").Select(k => k.SelectionValue)).Distinct();

                                                            foreach (var selection in loserSelections)
                                                            {
                                                                if (selection != null)
                                                                {
                                                                    <img style="width:20px;height:20px" src="~/Content/Characters/@(selection).jpg" />
                                                                }
                                                            }
                                                        }
                                                    }
                                                    @if (i % 2 == 1)
                                                    {
                                                        @($" (out @ {SmashExplorerDatabase.Instance.GetStringOrdinal(upset.Set.LPlacement ?? -1)})")
                                                    }
                                                </a>
                                            </td>
                                            @{
                                                var additionalDisplay = "";
                                                var loserName = upset.Set.Entrants.Where(x => x.Id != upset.Set.WinnerId).SingleOrDefault()?.Name;
                                                if (i % 2 == 1)
                                                {
                                                    additionalDisplay = $"{loserName} -> out @ {SmashExplorerDatabase.Instance.GetStringOrdinal(upset.Set.LPlacement ?? -1)} in {phase}";
                                                }
                                                else
                                                {
                                                    additionalDisplay = $"{loserName} -> lowest possible placement {SmashExplorerDatabase.Instance.GetStringOrdinal(upset.Set.LPlacement ?? -1)} in {phase}";
                                                }
                                            }
                                            <td class="col-md-3">
                                                @upset.UpsetFactor
                                                <a id="@upset.Set.Id" style="margin-left:10px" class="twitter-share-button"
                                                   onclick='foo("@keysList[i]", "@phase", "@Model.Event.Name - @Model.Event.TournamentName", "@Model.Event.Id", "@upset.Set.Id", "@upset.NewDisplayScore", "@additionalDisplay", "@upset.UpsetFactor")'><img src="~/Content/twitter.png" style="height:15px;width:15px" />Share</a>
                                            </td>
                                        </tr>
                                    }
                                </table>
                            }
                        </div>
                    </div>
                }
                if (start % 2 == 0)
                {
                @:</div>
            }
        }
    }
    else
    {
        <h1>No upsets reported so far. Come back later!</h1>
    }
</div>
@if (Model.DQEntrants != null && Model.DQEntrants.Count > 0)
{
    <div class="row">
        <div class="col-md-6">
            <h3>DQs</h3>
            <ul>
                @foreach (var dqEntrant in Model.DQEntrants)
                {
                    <li><a href="https://start.gg/@Model.Event.Slug/entrant/@dqEntrant.Id" target="_blank">@dqEntrant.Name</a> (@dqEntrant.Seeding seed)</li>
                }
            </ul>
        </div>
    </div>
}
